{% extends "base.html" %}

{% block title %}Cart - Pavitra Enterprises{% endblock %}

{% block content %}
<!-- Page Title -->
<div class="page-title light-background">
  <div class="container d-lg-flex justify-content-between align-items-center">
    <h1 class="mb-2 mb-lg-0">Cart</h1>
    <nav class="breadcrumbs">
      <ol>
        <li><a href="{{ url_for('shop.index') }}">Home</a></li>
        <li class="current">Cart</li>
      </ol>
    </nav>
  </div>
</div><!-- End Page Title -->

<!-- Cart Section -->
<section id="cart" class="cart section">
  <div class="container" data-aos="fade-up" data-aos-delay="100">
    <div class="row">
      <div class="col-lg-8" data-aos="fade-up" data-aos-delay="200">
        <div class="cart-items">
          <div class="cart-header d-none d-lg-block">
            <div class="row align-items-center">
              <div class="col-lg-6">
                <h5>Product</h5>
              </div>
              <div class="col-lg-2 text-center">
                <h5>Price</h5>
              </div>
              <div class="col-lg-2 text-center">
                <h5>Quantity</h5>
              </div>
              <div class="col-lg-2 text-center">
                <h5>Total</h5>
              </div>
            </div>
          </div>

          {% if cart %}
            {% for item in cart %}
            <!-- Cart Item -->
            <div class="cart-item">
              <div class="row align-items-center">
                <div class="col-lg-6 col-12 mt-3 mt-lg-0 mb-lg-0 mb-3">
                  <div class="product-info d-flex align-items-center">
                    <div class="product-image">
                      <img src="{{ url_for('static', filename='img/product/product-' ~ (loop.index % 12 + 1) ~ '.webp') }}" alt="{{ item.name }}" class="img-fluid" loading="lazy">
                    </div>
                    <div class="product-details">
                      <h6 class="product-title">{{ item.name }}</h6>
                      <div class="product-meta">
                        <span class="product-color">Color: Black</span>
                        <span class="product-size">Size: M</span>
                      </div>
                      <a href="{{ url_for('shop.remove_from_cart', pid=item.id) }}" class="remove-item">
                        <i class="bi bi-trash"></i> Remove
                      </a>
                    </div>
                  </div>
                </div>
                <div class="col-lg-2 col-12 mt-3 mt-lg-0 text-center">
                  <div class="price-tag">
                    <span class="current-price">${{ "%.2f"|format(item.price) }}</span>
                  </div>
                </div>
                <div class="col-lg-2 col-12 mt-3 mt-lg-0 text-center">
                  <form method="POST" action="{{ url_for('shop.update_cart', pid=item.id) }}" class="quantity-form">
                    <div class="quantity-selector">
                      <button type="button" class="quantity-btn decrease" onclick="updateQuantity({{ item.id }}, -1)">
                        <i class="bi bi-dash"></i>
                      </button>
                      <input type="number" class="quantity-input" name="quantity" value="{{ item.qty }}" min="1" max="10" data-item-id="{{ item.id }}">
                      <button type="button" class="quantity-btn increase" onclick="updateQuantity({{ item.id }}, 1)">
                        <i class="bi bi-plus"></i>
                      </button>
                    </div>
                  </form>
                </div>
                <div class="col-lg-2 col-12 mt-3 mt-lg-0 text-center">
                  <div class="item-total">
                    <span>${{ "%.2f"|format(item.price * item.qty) }}</span>
                  </div>
                </div>
              </div>
            </div><!-- End Cart Item -->
            {% endfor %}
          {% else %}
          <div class="empty-cart" data-aos="fade-up">
            <div class="empty-icon">
              <i class="bi bi-cart-x"></i>
            </div>
            <h3>Your Cart is Empty</h3>
            <p>Looks like you haven't added any items to your cart yet.</p>
            <a href="{{ url_for('shop.category') }}" class="btn btn-primary">Start Shopping</a>
          </div>
          {% endif %}

          {% if cart %}
          <div class="cart-actions">
            <div class="row">
              <div class="col-lg-6 mb-3 mb-lg-0">
                <div class="coupon-form">
                  <div class="input-group">
                    <input type="text" class="form-control" placeholder="Coupon code">
                    <button class="btn btn-outline-accent" type="button">Apply Coupon</button>
                  </div>
                </div>
              </div>
              <div class="col-lg-6 text-md-end">
                <a href="{{ url_for('shop.category') }}" class="btn btn-outline-heading me-2">
                  <i class="bi bi-arrow-clockwise"></i> Continue Shopping
                </a>
                <a href="{{ url_for('shop.cart') }}" class="btn btn-outline-remove" onclick="clearCart()">
                  <i class="bi bi-trash"></i> Clear Cart
                </a>
              </div>
            </div>
          </div>
          {% endif %}
        </div>
      </div>

      {% if cart %}
      <div class="col-lg-4 mt-4 mt-lg-0" data-aos="fade-up" data-aos-delay="300">
        <div class="cart-summary">
          <h4 class="summary-title">Order Summary</h4>

          <div class="summary-item">
            <span class="summary-label">Subtotal</span>
            <span class="summary-value">${{ "%.2f"|format(total) }}</span>
          </div>

          <div class="summary-item shipping-item">
            <span class="summary-label">Shipping</span>
            <div class="shipping-options">
              <div class="form-check text-end">
                <input class="form-check-input" type="radio" name="shipping" id="standard" checked="">
                <label class="form-check-label" for="standard">
                  Standard Delivery - $4.99
                </label>
              </div>
              <div class="form-check text-end">
                <input class="form-check-input" type="radio" name="shipping" id="express">
                <label class="form-check-label" for="express">
                  Express Delivery - $12.99
                </label>
              </div>
              <div class="form-check text-end">
                <input class="form-check-input" type="radio" name="shipping" id="free" {% if total >= 50 %}checked{% endif %}>
                <label class="form-check-label" for="free">
                  Free Shipping (Orders over $50)
                </label>
              </div>
            </div>
          </div>

          <div class="summary-item">
            <span class="summary-label">Tax</span>
            <span class="summary-value">${{ "%.2f"|format(total * 0.08) }}</span>
          </div>

          <div class="summary-item discount">
            <span class="summary-label">Discount</span>
            <span class="summary-value">-$0.00</span>
          </div>

          {% set shipping_cost = 0 if total >= 50 else 4.99 %}
          {% set final_total = total + (total * 0.08) + shipping_cost %}
          
          <div class="summary-total">
            <span class="summary-label">Total</span>
            <span class="summary-value">${{ "%.2f"|format(final_total) }}</span>
          </div>

          <div class="checkout-button">
            <a href="{{ url_for('shop.checkout') }}" class="btn btn-accent w-100">
              Proceed to Checkout <i class="bi bi-arrow-right"></i>
            </a>
          </div>

          <div class="continue-shopping">
            <a href="{{ url_for('shop.category') }}" class="btn btn-link w-100">
              <i class="bi bi-arrow-left"></i> Continue Shopping
            </a>
          </div>

          <div class="payment-methods">
            <p class="payment-title">We Accept</p>
            <div class="payment-icons">
              <i class="bi bi-credit-card"></i>
              <i class="bi bi-paypal"></i>
              <i class="bi bi-wallet2"></i>
              <i class="bi bi-bank"></i>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</section><!-- /Cart Section -->
{% endblock %}

{% block scripts %}
<!-- Additional scripts for cart page -->
<script>
function updateQuantity(itemId, change) {
  const quantityInput = document.querySelector(`input[data-item-id="${itemId}"]`);
  let newQuantity = parseInt(quantityInput.value) + change;
  
  if (newQuantity < 1) newQuantity = 1;
  if (newQuantity > 10) newQuantity = 10;
  
  quantityInput.value = newQuantity;
  
  // Submit the form to update the cart
  const form = quantityInput.closest('form');
  form.submit();
}

function clearCart() {
  if (confirm('Are you sure you want to clear your cart?')) {
    // This would typically be handled by a server-side route
    // For now, we'll redirect to a clear cart endpoint
    window.location.href = "{{ url_for('shop.cart') }}?clear=1";
  }
}

// Auto-update cart when quantity changes
document.addEventListener('DOMContentLoaded', function() {
  const quantityInputs = document.querySelectorAll('.quantity-input');
  quantityInputs.forEach(input => {
    input.addEventListener('change', function() {
      const form = this.closest('form');
      if (form) {
        form.submit();
      }
    });
  });

  // Handle shipping option changes
  const shippingRadios = document.querySelectorAll('input[name="shipping"]');
  shippingRadios.forEach(radio => {
    radio.addEventListener('change', function() {
      // This would typically recalculate totals via AJAX
      console.log('Shipping option changed:', this.id);
    });
  });
});
</script>
{% endblock %}