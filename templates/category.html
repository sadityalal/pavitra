{% extends "base.html" %}

{% block title %}{{ category.name if category else 'All Categories' }} - Pavitra Enterprises{% endblock %}
{% block description %}{{ category.description if category else 'Browse our complete collection of products across all categories.' }}{% endblock %}
{% block keywords %}{{ category.name if category }}, products, shopping, ecommerce{% endblock %}

{% block content %}
<!-- Category Header Section -->
<section class="category-header section">
  <div class="container" data-aos="fade-up">
    <div class="row align-items-center">
      <div class="col-lg-8">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('shop.index') }}">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('shop.category') }}">Categories</a></li>
            {% if category %}
            <li class="breadcrumb-item active" aria-current="page">{{ category.name }}</li>
            {% else %}
            <li class="breadcrumb-item active" aria-current="page">All Products</li>
            {% endif %}
          </ol>
        </nav>

        <h1 class="category-title">
          {% if category %}
            {{ category.name }}
          {% else %}
            All Products
          {% endif %}
        </h1>

        {% if category %}
        <p class="category-description">{{ category.description or 'Explore our amazing collection of ' + category.name }}</p>
        {% else %}
        <p class="category-description">Browse our complete collection of products across all categories</p>
        {% endif %}

        <div class="category-stats">
          <span class="product-count">{{ products|length }} products found</span>
          {% if category %}
          <span class="category-badge">{{ category.name }}</span>
          {% endif %}
        </div>
      </div>

      <div class="col-lg-4 text-lg-end">
        <div class="category-image">
          {% if category and category.image_url %}
          <img src="{{ category.image_url }}" alt="{{ category.name }}" class="img-fluid rounded">
          {% else %}
          <div class="category-placeholder">
            <i class="bi bi-grid-3x3-gap"></i>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Category Filters & Products Section -->
<section class="category-products section">
  <div class="container">
    <div class="row">
      <!-- Sidebar Filters -->
      <div class="col-lg-3" data-aos="fade-right">
        <div class="filters-sidebar">
          <div class="filter-group">
            <div class="filter-header">
              <h5>Categories</h5>
            </div>
            <div class="filter-content">
              <div class="category-list">
                <a href="{{ url_for('shop.category') }}" class="category-item {% if not category %}active{% endif %}">
                  <span>All Categories</span>
                  <span class="count">({{ total_products }})</span>
                </a>
                {% for cat in categories %}
                <a href="{{ url_for('shop.category', slug=cat.slug) }}" class="category-item {% if category and category.id == cat.id %}active{% endif %}">
                  <span>{{ cat.name }}</span>
                  <span class="count">({{ cat.products|length }})</span>
                </a>
                {% endfor %}
              </div>
            </div>
          </div>

          <div class="filter-group">
            <div class="filter-header">
              <h5>Price Range</h5>
            </div>
            <div class="filter-content">
              <div class="price-filter">
                <div class="price-inputs">
                  <input type="number" id="min-price" placeholder="Min" value="{{ request.args.get('min_price', '') }}">
                  <span>-</span>
                  <input type="number" id="max-price" placeholder="Max" value="{{ request.args.get('max_price', '') }}">
                </div>
                <button id="apply-price-filter" class="btn btn-sm btn-primary mt-2">Apply</button>
              </div>
            </div>
          </div>

          <div class="filter-group">
            <div class="filter-header">
              <h5>Availability</h5>
            </div>
            <div class="filter-content">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="in-stock" {% if request.args.get('in_stock') %}checked{% endif %}>
                <label class="form-check-label" for="in-stock">
                  In Stock Only
                </label>
              </div>
            </div>
          </div>

          <div class="filter-group">
            <div class="filter-header">
              <h5>Sort By</h5>
            </div>
            <div class="filter-content">
              <select class="form-select" id="sort-by">
                <option value="newest" {% if request.args.get('sort') == 'newest' %}selected{% endif %}>Newest First</option>
                <option value="price_low" {% if request.args.get('sort') == 'price_low' %}selected{% endif %}>Price: Low to High</option>
                <option value="price_high" {% if request.args.get('sort') == 'price_high' %}selected{% endif %}>Price: High to Low</option>
                <option value="name" {% if request.args.get('sort') == 'name' %}selected{% endif %}>Name A-Z</option>
                <option value="rating" {% if request.args.get('sort') == 'rating' %}selected{% endif %}>Highest Rated</option>
              </select>
            </div>
          </div>

          <button id="clear-filters" class="btn btn-outline-secondary w-100 mt-3">Clear All Filters</button>
        </div>
      </div>

      <!-- Products Grid -->
      <div class="col-lg-9" data-aos="fade-left">
        <!-- Products Header -->
        <div class="products-header mb-4">
          <div class="row align-items-center">
            <div class="col-md-6">
              <div class="view-options">
                <button class="view-btn active" data-view="grid">
                  <i class="bi bi-grid-3x3-gap"></i>
                </button>
                <button class="view-btn" data-view="list">
                  <i class="bi bi-list"></i>
                </button>
              </div>
            </div>
            <div class="col-md-6 text-md-end">
              <div class="products-meta">
                <span>Showing {{ products|length }} of {{ total_products }} products</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Products Grid -->
        <div class="products-grid" id="products-container">
          {% if products %}
          <div class="row gy-4">
            {% for product in products %}
            <div class="col-xl-4 col-md-6">
              <div class="product-card">
                <div class="product-image">
                  <img src="{{ product.image_url or url_for('static', filename='img/product/placeholder.jpg') }}" alt="{{ product.name }}" class="img-fluid">
                  <div class="product-badges">
                    {% if product.is_featured %}
                    <span class="badge-featured">Featured</span>
                    {% endif %}
                    {% if product.compare_price and product.compare_price > product.price %}
                    <span class="badge-sale">-{{ product.get_discount_percentage() }}%</span>
                    {% endif %}
                    {% if product.is_new() %}
                    <span class="badge-new">New</span>
                    {% endif %}
                    {% if product.is_low_stock() %}
                    <span class="badge-warning">Low Stock</span>
                    {% endif %}
                  </div>
                  <div class="product-actions">
                    {% if user %}
                    <a href="{{ url_for('shop.add_to_wishlist', product_id=product.id) }}" class="action-btn wishlist-btn" title="Add to Wishlist">
                      <i class="bi bi-heart"></i>
                    </a>
                    {% endif %}
                    <a href="{{ url_for('shop.product_details', slug=product.slug) }}" class="action-btn view-btn" title="Quick View">
                      <i class="bi bi-eye"></i>
                    </a>
                  </div>
                  {% if product.is_in_stock() %}
                  <form action="{{ url_for('shop.add_to_cart', product_id=product.id) }}" method="POST" class="add-to-cart-form">
                    <button type="submit" class="cart-btn">
                      <i class="bi bi-cart-plus"></i> Add to Cart
                    </button>
                  </form>
                  {% else %}
                  <button class="cart-btn out-of-stock" disabled>
                    <i class="bi bi-x-circle"></i> Out of Stock
                  </button>
                  {% endif %}
                </div>
                <div class="product-info">
                  <div class="product-category">{{ product.category.name if product.category else 'Uncategorized' }}</div>
                  <h4 class="product-name">
                    <a href="{{ url_for('shop.product_details', slug=product.slug) }}">{{ product.name }}</a>
                  </h4>
                  <div class="product-rating">
                    <div class="stars">
                      {% set avg_rating = product.get_average_rating() %}
                      {% for i in range(5) %}
                        {% if i < avg_rating %}
                          <i class="bi bi-star-fill text-warning"></i>
                        {% else %}
                          <i class="bi bi-star text-muted"></i>
                        {% endif %}
                      {% endfor %}
                    </div>
                    <span class="rating-count">({{ product.get_review_count() }})</span>
                  </div>
                  <div class="product-price">
                    {% if product.compare_price and product.compare_price > product.price %}
                    <span class="old-price">${{ "%.2f"|format(product.compare_price) }}</span>
                    {% endif %}
                    <span class="current-price">${{ "%.2f"|format(product.price) }}</span>
                  </div>
                  {% if product.is_low_stock() and product.is_in_stock() %}
                  <div class="stock-info">
                    <small class="text-warning">Only {{ product.inventory_quantity }} left!</small>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="text-center py-5">
            <div class="empty-state">
              <i class="bi bi-search display-1 text-muted"></i>
              <h3>No Products Found</h3>
              <p class="text-muted">We couldn't find any products matching your criteria.</p>
              <a href="{{ url_for('shop.category') }}" class="btn btn-primary">Browse All Products</a>
            </div>
          </div>
          {% endif %}
        </div>

        <!-- Load More Button (if pagination is implemented) -->
        {% if has_more %}
        <div class="text-center mt-5">
          <button id="load-more" class="btn btn-outline-primary" data-page="2">Load More Products</button>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // View toggle
  const viewButtons = document.querySelectorAll('.view-btn');
  const productsContainer = document.getElementById('products-container');

  viewButtons.forEach(button => {
    button.addEventListener('click', function() {
      viewButtons.forEach(btn => btn.classList.remove('active'));
      this.classList.add('active');

      const view = this.getAttribute('data-view');
      productsContainer.setAttribute('data-view', view);
    });
  });

  // Price filter
  document.getElementById('apply-price-filter').addEventListener('click', function() {
    const minPrice = document.getElementById('min-price').value;
    const maxPrice = document.getElementById('max-price').value;
    applyFilters();
  });

  // Sort by
  document.getElementById('sort-by').addEventListener('change', function() {
    applyFilters();
  });

  // In stock filter
  document.getElementById('in-stock').addEventListener('change', function() {
    applyFilters();
  });

  // Clear filters
  document.getElementById('clear-filters').addEventListener('click', function() {
    document.getElementById('min-price').value = '';
    document.getElementById('max-price').value = '';
    document.getElementById('sort-by').value = 'newest';
    document.getElementById('in-stock').checked = false;
    applyFilters();
  });

  function applyFilters() {
    const params = new URLSearchParams();

    // Add current category if exists
    {% if category %}
    params.append('category', '{{ category.slug }}');
    {% endif %}

    // Add filters
    const minPrice = document.getElementById('min-price').value;
    const maxPrice = document.getElementById('max-price').value;
    const sortBy = document.getElementById('sort-by').value;
    const inStock = document.getElementById('in-stock').checked;

    if (minPrice) params.append('min_price', minPrice);
    if (maxPrice) params.append('max_price', maxPrice);
    if (sortBy) params.append('sort', sortBy);
    if (inStock) params.append('in_stock', 'true');

    window.location.href = '{{ url_for("shop.category") }}?' + params.toString();
  }

  // Add to cart animation
  const addToCartForms = document.querySelectorAll('.add-to-cart-form');
  addToCartForms.forEach(form => {
    form.addEventListener('submit', function(e) {
      e.preventDefault();

      const button = this.querySelector('.cart-btn');
      const originalText = button.innerHTML;

      button.innerHTML = '<i class="bi bi-check"></i> Added!';
      button.disabled = true;

      // Submit the form after animation
      setTimeout(() => {
        form.submit();
      }, 500);
    });
  });
});
</script>
{% endblock %}