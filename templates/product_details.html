{% extends "base.html" %}

{% block title %}{{ product.name }} - Pavitra Enterprises{% endblock %}
{% block description %}{{ product.meta_description or product.description|striptags|truncate(160) }}{% endblock %}
{% block keywords %}{{ product.name }}, {{ product.category.name if product.category }}, buy {{ product.name }}{% endblock %}

{% block content %}
<!-- Product Detail Section -->
<section class="product-detail section">
  <div class="container">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('shop.index') }}">Home</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('shop.category') }}">Categories</a></li>
        {% if product.category %}
        <li class="breadcrumb-item"><a href="{{ url_for('shop.category', slug=product.category.slug) }}">{{ product.category.name }}</a></li>
        {% endif %}
        <li class="breadcrumb-item active" aria-current="page">{{ product.name|truncate(30) }}</li>
      </ol>
    </nav>

    <div class="row">
      <!-- Product Images -->
      <div class="col-lg-6" data-aos="fade-right">
        <div class="product-gallery">
          <!-- Main Image -->
          <div class="main-image mb-3">
            <img id="main-product-image" src="{{ product.image_url or url_for('static', filename='img/product/placeholder.jpg') }}" alt="{{ product.name }}" class="img-fluid" data-zoom="{{ product.image_url or url_for('static', filename='img/product/placeholder.jpg') }}">
          </div>
          
          <!-- Thumbnail Images -->
          <div class="thumbnail-images">
            <div class="thumbnails-container">
              {% set product_images = [product.image_url] + (product.additional_images or []) %}
              {% for image in product_images %}
                {% if image %}
                <div class="thumbnail-item {% if loop.first %}active{% endif %}" data-image="{{ image }}">
                  <img src="{{ image }}" alt="{{ product.name }} - Image {{ loop.index }}" class="img-fluid">
                </div>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        </div>
      </div>

      <!-- Product Info -->
      <div class="col-lg-6" data-aos="fade-left">
        <div class="product-info">
          <!-- Product Header -->
          <div class="product-header mb-3">
            <div class="product-badges">
              {% if product.is_featured %}
              <span class="badge-featured">Featured</span>
              {% endif %}
              {% if product.compare_price and product.compare_price > product.price %}
              <span class="badge-sale">-{{ product.get_discount_percentage() }}%</span>
              {% endif %}
              {% if product.is_new() %}
              <span class="badge-new">New</span>
              {% endif %}
            </div>
            
            <h1 class="product-title">{{ product.name }}</h1>
            
            <div class="product-meta">
              <div class="product-rating">
                <div class="stars">
                  {% set avg_rating = product.get_average_rating() %}
                  {% for i in range(5) %}
                    {% if i < avg_rating %}
                      <i class="bi bi-star-fill text-warning"></i>
                    {% else %}
                      <i class="bi bi-star text-muted"></i>
                    {% endif %}
                  {% endfor %}
                </div>
                <span class="rating-value">{{ "%.1f"|format(avg_rating) }}</span>
                <span class="rating-count">({{ product.get_review_count() }} reviews)</span>
                <a href="#reviews" class="review-link">Write a review</a>
              </div>
              
              <div class="product-sku">
                <span>SKU: {{ product.sku or 'N/A' }}</span>
              </div>
            </div>
          </div>

          <!-- Product Price -->
          <div class="product-price mb-3">
            {% if product.compare_price and product.compare_price > product.price %}
            <div class="price-original">${{ "%.2f"|format(product.compare_price) }}</div>
            {% endif %}
            <div class="price-current">${{ "%.2f"|format(product.price) }}</div>
            {% if product.compare_price and product.compare_price > product.price %}
            <div class="price-save">
              You save ${{ "%.2f"|format(product.compare_price - product.price) }} ({{ product.get_discount_percentage() }}%)
            </div>
            {% endif %}
          </div>

          <!-- Product Description -->
          <div class="product-description mb-4">
            <p>{{ product.description|safe }}</p>
          </div>

          <!-- Product Variants (if any) -->
          {% if product.variants %}
          <div class="product-variants mb-4">
            <h6>Options:</h6>
            <div class="variant-options">
              {% for variant in product.variants %}
              <div class="form-check">
                <input class="form-check-input" type="radio" name="variant" id="variant-{{ variant.id }}" value="{{ variant.id }}" {% if loop.first %}checked{% endif %}>
                <label class="form-check-label" for="variant-{{ variant.id }}">
                  {{ variant.name }} - ${{ "%.2f"|format(variant.price) }}
                  {% if variant.inventory_quantity <= 0 %}
                  <span class="text-danger">(Out of Stock)</span>
                  {% endif %}
                </label>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <!-- Add to Cart -->
          <div class="product-actions mb-4">
            {% if product.is_in_stock() %}
            <form action="{{ url_for('shop.add_to_cart', product_id=product.id) }}" method="POST" class="add-to-cart-form">
              <div class="row g-3 align-items-center">
                <div class="col-auto">
                  <label for="quantity" class="col-form-label">Quantity:</label>
                </div>
                <div class="col-auto">
                  <div class="quantity-selector">
                    <button type="button" class="quantity-btn minus">-</button>
                    <input type="number" name="quantity" id="quantity" class="form-control" value="1" min="1" max="{{ product.inventory_quantity }}">
                    <button type="button" class="quantity-btn plus">+</button>
                  </div>
                </div>
                <div class="col-auto">
                  <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-cart-plus"></i> Add to Cart
                  </button>
                </div>
              </div>
            </form>
            {% else %}
            <div class="out-of-stock-message">
              <button class="btn btn-secondary btn-lg" disabled>
                <i class="bi bi-x-circle"></i> Out of Stock
              </button>
              <p class="text-muted mt-2">This product is currently unavailable</p>
            </div>
            {% endif %}
          </div>

          <!-- Additional Actions -->
          <div class="product-secondary-actions mb-4">
            <div class="d-flex gap-3">
              {% if user %}
              <a href="{{ url_for('shop.add_to_wishlist', product_id=product.id) }}" class="btn btn-outline-secondary">
                <i class="bi bi-heart"></i> Add to Wishlist
              </a>
              {% endif %}
              <button class="btn btn-outline-secondary" onclick="shareProduct()">
                <i class="bi bi-share"></i> Share
              </button>
            </div>
          </div>

          <!-- Product Features -->
          <div class="product-features">
            <div class="feature-item">
              <i class="bi bi-truck"></i>
              <span>Free shipping on orders over $50</span>
            </div>
            <div class="feature-item">
              <i class="bi bi-arrow-clockwise"></i>
              <span>30-day money back guarantee</span>
            </div>
            <div class="feature-item">
              <i class="bi bi-shield-check"></i>
              <span>Secure payment</span>
            </div>
            {% if product.is_low_stock() and product.is_in_stock() %}
            <div class="feature-item text-warning">
              <i class="bi bi-exclamation-triangle"></i>
              <span>Only {{ product.inventory_quantity }} left in stock!</span>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Product Tabs -->
    <div class="row mt-5">
      <div class="col-12">
        <div class="product-tabs">
          <ul class="nav nav-tabs" id="productTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="description-tab" data-bs-toggle="tab" data-bs-target="#description" type="button" role="tab">Description</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="specifications-tab" data-bs-toggle="tab" data-bs-target="#specifications" type="button" role="tab">Specifications</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button" role="tab">Reviews ({{ product.get_review_count() }})</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="shipping-tab" data-bs-toggle="tab" data-bs-target="#shipping" type="button" role="tab">Shipping & Returns</button>
            </li>
          </ul>
          
          <div class="tab-content" id="productTabsContent">
            <!-- Description Tab -->
            <div class="tab-pane fade show active" id="description" role="tabpanel">
              <div class="p-4">
                {{ product.description|safe }}
              </div>
            </div>
            
            <!-- Specifications Tab -->
            <div class="tab-pane fade" id="specifications" role="tabpanel">
              <div class="p-4">
                {% if product.specifications %}
                <div class="specifications-table">
                  {% for spec in product.specifications %}
                  <div class="spec-row">
                    <div class="spec-name">{{ spec.name }}</div>
                    <div class="spec-value">{{ spec.value }}</div>
                  </div>
                  {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">No specifications available for this product.</p>
                {% endif %}
              </div>
            </div>
            
            <!-- Reviews Tab -->
            <div class="tab-pane fade" id="reviews" role="tabpanel">
              <div class="p-4">
                <div class="row">
                  <div class="col-lg-4">
                    <div class="reviews-summary text-center">
                      <div class="average-rating">
                        <h2>{{ "%.1f"|format(avg_rating) }}</h2>
                        <div class="stars">
                          {% for i in range(5) %}
                            {% if i < avg_rating %}
                              <i class="bi bi-star-fill text-warning"></i>
                            {% else %}
                              <i class="bi bi-star text-muted"></i>
                            {% endif %}
                          {% endfor %}
                        </div>
                        <p>Based on {{ product.get_review_count() }} reviews</p>
                      </div>
                    </div>
                  </div>
                  <div class="col-lg-8">
                    {% if user %}
                    <div class="add-review-form mb-4">
                      <h5>Write a Review</h5>
                      <form action="{{ url_for('shop.add_review', product_id=product.id) }}" method="POST">
                        <div class="mb-3">
                          <label class="form-label">Rating</label>
                          <div class="rating-input">
                            {% for i in range(5, 0, -1) %}
                            <input type="radio" id="star{{ i }}" name="rating" value="{{ i }}">
                            <label for="star{{ i }}"><i class="bi bi-star-fill"></i></label>
                            {% endfor %}
                          </div>
                        </div>
                        <div class="mb-3">
                          <textarea class="form-control" name="comment" placeholder="Write your review..." rows="3"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Submit Review</button>
                      </form>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                      <a href="{{ url_for('auth.login') }}">Sign in</a> to write a review.
                    </div>
                    {% endif %}
                    
                    <!-- Reviews List -->
                    <div class="reviews-list">
                      {% for review in product.reviews %}
                      <div class="review-item">
                        <div class="review-header">
                          <div class="reviewer-name">{{ review.user.name }}</div>
                          <div class="review-rating">
                            {% for i in range(5) %}
                              {% if i < review.rating %}
                                <i class="bi bi-star-fill text-warning"></i>
                              {% else %}
                                <i class="bi bi-star text-muted"></i>
                              {% endif %}
                            {% endfor %}
                          </div>
                        </div>
                        <div class="review-content">
                          <p>{{ review.comment }}</p>
                        </div>
                        <div class="review-date">
                          {{ review.created_at.strftime('%B %d, %Y') }}
                        </div>
                      </div>
                      {% else %}
                      <p class="text-muted">No reviews yet. Be the first to review this product!</p>
                      {% endfor %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Shipping Tab -->
            <div class="tab-pane fade" id="shipping" role="tabpanel">
              <div class="p-4">
                <h5>Shipping Information</h5>
                <ul>
                  <li>Free standard shipping on orders over $50</li>
                  <li>Express shipping available for an additional fee</li>
                  <li>Most orders ship within 1-2 business days</li>
                  <li>Tracking information provided for all orders</li>
                </ul>
                
                <h5 class="mt-4">Return Policy</h5>
                <ul>
                  <li>30-day money back guarantee</li>
                  <li>Items must be in original condition</li>
                  <li>Free returns for defective items</li>
                  <li>Return shipping paid by customer for non-defective items</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Related Products -->
    {% if related_products %}
    <section class="related-products section mt-5">
      <div class="container" data-aos="fade-up">
        <div class="section-title">
          <h2>Related Products</h2>
          <p>You might also like</p>
        </div>
        
        <div class="row gy-4">
          {% for related_product in related_products %}
          <div class="col-lg-3 col-md-6">
            <div class="product-card">
              <div class="product-image">
                <img src="{{ related_product.image_url or url_for('static', filename='img/product/placeholder.jpg') }}" alt="{{ related_product.name }}" class="img-fluid">
                <div class="product-actions">
                  {% if user %}
                  <a href="{{ url_for('shop.add_to_wishlist', product_id=related_product.id) }}" class="action-btn wishlist-btn" title="Add to Wishlist">
                    <i class="bi bi-heart"></i>
                  </a>
                  {% endif %}
                  <a href="{{ url_for('shop.product_details', slug=related_product.slug) }}" class="action-btn view-btn" title="Quick View">
                    <i class="bi bi-eye"></i>
                  </a>
                </div>
                {% if related_product.is_in_stock() %}
                <form action="{{ url_for('shop.add_to_cart', product_id=related_product.id) }}" method="POST" class="add-to-cart-form">
                  <button type="submit" class="cart-btn">
                    <i class="bi bi-cart-plus"></i> Add to Cart
                  </button>
                </form>
                {% endif %}
              </div>
              <div class="product-info">
                <h4 class="product-name">
                  <a href="{{ url_for('shop.product_details', slug=related_product.slug) }}">{{ related_product.name }}</a>
                </h4>
                <div class="product-price">
                  <span class="current-price">${{ "%.2f"|format(related_product.price) }}</span>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </section>
    {% endif %}
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Image gallery functionality
  const mainImage = document.getElementById('main-product-image');
  const thumbnails = document.querySelectorAll('.thumbnail-item');
  
  thumbnails.forEach(thumb => {
    thumb.addEventListener('click', function() {
      // Update active thumbnail
      thumbnails.forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      
      // Update main image
      const newImage = this.getAttribute('data-image');
      mainImage.src = newImage;
      mainImage.setAttribute('data-zoom', newImage);
    });
  });

  // Quantity selector
  const quantityInput = document.getElementById('quantity');
  const minusBtn = document.querySelector('.quantity-btn.minus');
  const plusBtn = document.querySelector('.quantity-btn.plus');
  
  minusBtn.addEventListener('click', function() {
    let value = parseInt(quantityInput.value);
    if (value > 1) {
      quantityInput.value = value - 1;
    }
  });
  
  plusBtn.addEventListener('click', function() {
    let value = parseInt(quantityInput.value);
    const max = parseInt(quantityInput.getAttribute('max'));
    if (value < max) {
      quantityInput.value = value + 1;
    }
  });

  // Initialize image zoom
  if (typeof Drift !== 'undefined') {
    new Drift(mainImage, {
      paneContainer: mainImage,
      inlinePane: false,
      zoomFactor: 2
    });
  }

  // Add to cart animation
  const addToCartForm = document.querySelector('.add-to-cart-form');
  if (addToCartForm) {
    addToCartForm.addEventListener('submit', function(e) {
      const button = this.querySelector('button[type="submit"]');
      const originalText = button.innerHTML;
      
      button.innerHTML = '<i class="bi bi-check"></i> Added to Cart!';
      button.disabled = true;
      
      setTimeout(() => {
        button.innerHTML = originalText;
        button.disabled = false;
      }, 2000);
    });
  }

  // Star rating for reviews
  const ratingInputs = document.querySelectorAll('.rating-input input');
  ratingInputs.forEach(input => {
    input.addEventListener('change', function() {
      const rating = this.value;
      // You can add any additional logic here
    });
  });
});

function shareProduct() {
  if (navigator.share) {
    navigator.share({
      title: '{{ product.name }}',
      text: 'Check out this product from Pavitra Enterprises',
      url: window.location.href
    })
    .catch(error => console.log('Error sharing:', error));
  } else {
    // Fallback: copy to clipboard
    navigator.clipboard.writeText(window.location.href)
      .then(() => alert('Product link copied to clipboard!'))
      .catch(err => console.log('Error copying to clipboard:', err));
  }
}
</script>
{% endblock %}